---
title: "Antimicrobial Resistance in Organic and Conventional farms: A sytemic literature review"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r load-packages, include=FALSE}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(ggpubr)
library(patchwork)
library(scales)
library(wesanderson)
library(ggpubr)

```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




We identified 1836 references in three search databases: Pub Med, Web of Science, and PubAg, from studies published between 2000 and 2022.  The studies reported the point prevalence of antimicrobial resistance in Organic and Conventional farms. Three duplicates were removed, and the remaining 1833 unique references were subjected to relevance screening, with 1744 references being removed. After assessing the remaining 89 references for eligibility, 17 were removed. The systematic review included 72 studies that met our criteria (*fig.1*). The North America accounted for 46% (n=33) of the surveys.Europe accounted for 36% (n=26), 14% (n=10) of studies were from Asia while Oceania and South America contributed to 3% (n=2) and 1% (n=1) of the studies respectively.

```{r no_studies, echo=FALSE, fig.height=6, fig.width=14, message=FALSE}
#Load data
main_data <- read_csv("conv.csv")


data1 <- main_data %>%
  select(doi, continent, year)

data2 <- data1 %>%
  group_by(continent)%>%
  count(doi, year)

data3 <- data2 %>%
  select(continent, year)


data4<- data3 %>%
  count(continent, year)

p1<- ggbarplot(data4, "year", 
          "n", 
          fill = "continent",
          subtitle = "",
          xlab = "Year of publication", ylab = "Number of publications",
          legend.title = "Continent",
          font.subtitle = "italic")+
  scale_fill_manual(values = wes_palette( "Darjeeling1", n=5))+
  rotate_x_text(60)

p1
```

#### Antimicrobial resistance trends in Organic and conventional farms


Percentage resistance of antimicrobial compounds increased in both organic and conventional farms between 2001 and 2020. The percentage resistance in organic farms increased from 10% 95% Confidence interval (CI: 2-18%) to 32% (CI: 23-41%) while in conventional farms the percentage resistance increased from 18% (CI: 12-28%) to 42% (CI: 33-51%) (p = 0.0215) (*fig2*). Generally, the mean resistance is higher in conventional farms 28% as compared to organic farms 18% (supplementary materials).


```{r trends, echo=FALSE, fig.height=6, fig.width=14, message=FALSE}

#Load data
main_data <- read_csv("mean.data.csv")

data1 <- main_data %>%
  select("antimicrobial", "doi", "antimicrobial_compound",
         "farm_type",
          
         "sampling_end_date", "mean")


data2 <- filter(data1, !is.na(data1$sampling_end_date))
 


data3 <-aggregate(mean~doi+farm_type+sampling_end_date, data2, mean)


#changing percentage resistance into numeric class and rounding off  
data3$mean <- as.numeric(as.character(data3$mean))

data3$mean <- round(data3$mean, digits = 0)

data3<- data3[which(data3$mean>= 1),]




##Organic farm plot

organic.data<- data3 %>%
  filter(farm_type == "Organic")
   
        
##Organic box plot

organic.p1<-ggboxplot(organic.data, "sampling_end_date", "mean", fill = "farm_type",
        xlab = "Year", ylab = "Percent resistance", 
           palette = c("#00AFBB")) +
  geom_boxplot(fill = "#00AFBB") +
  ggbeeswarm::geom_quasirandom(
    
    size = 1.5,
    alpha = .4,
    width = .2
  ) +
  rotate_x_text(60)

organic.plot <-ggpar(organic.p1, legend.title = "Farm type")



p1 <- organic.plot + geom_smooth(formula = y ~ x, method = "lm",color= "blue", aes(group=1))
##Conventional farm plot

conv.data<- data3 %>%
  filter(farm_type == "Conventional")


##Conventional box plot

conv.p1<-ggboxplot(conv.data, "sampling_end_date", "mean", fill = "farm_type",
                      xlab = "Year", ylab = "Percent resistance", 
                      palette = c("#FC4E07")) +
  geom_boxplot(fill = "#FC4E07") +
  ggbeeswarm::geom_quasirandom(
    
    size = 1.5,
    alpha = .4,
    width = .2
  ) +
  rotate_x_text(60)

conv.plot <-ggpar(conv.p1, legend.title = "Farm type")

p2 <- conv.plot + geom_smooth(formula = y ~ x, method = "lm",color= "blue", aes(group=1))
##Merging plots together using patchwork


trend.plot <- (p1 | p2)+ 
  plot_annotation(tag_levels = "a",
                  tag_prefix = "(",
                  tag_suffix = ")")+
  plot_layout(guides = "keep")&
  theme(plot.tag = element_text(),
        legend.position = "top")

trend.plot
```


#### Host resistance


In conventional farms, cattle, chicken, pigs, turkeys, and environments accounted for 14, 27, 16, 1 and 6 studies respectively while in organic farms, cattle, chicken, pigs, turkeys and environments accounted for 15, 32, 13, 2 and 5 studies respectively. There was higher resistance in conventional farms as compared to organic farms in cattle, chicken, pigs, and turkeys except in the environment where there was higher resistance in organic farms as compared to the conventional farms. In conventional farms, the resistance was 14.5% in cattle, 22% in chicken, 11.5% in environment, 24.5% in pigs and 46% in turkeys while the resistance rate in organic farms was 9% in cattle, 13.5% in chicken, 16% in environment, 15% in pigs and 22.5% in turkeys. 




```{r host,echo=FALSE, fig.height=6, fig.width=14, message=FALSE}
main_data <- read_csv("mean.data.csv")

#changing percentage resistance into numeric class and rounding off  
main_data$percent_resistant <- as.numeric(as.character
                                          (main_data$percent_resistant))

main_data$percent_resistant <- round(main_data$percent_resistant, digits = 0)


data2 <- main_data %>%
  group_by(host) %>%
  select("doi",
         "farm_type",
        "host",
        "percent_resistant")
         
         





data3 <-aggregate(percent_resistant~doi+farm_type+host, data2, mean)



#changing percentage resistance into numeric class and rounding off  
data3$percent_resistant <- as.numeric(as.character
                                      (data3$percent_resistant))

data3$percent_resistant <- round(data3$percent_resistant, digits = 0)

data3<- data3[which(data3$percent_resistant>= 1),]

#subseting organic farm data
Organic.data <- data3 %>%
  filter(farm_type == "Organic")


##Organic farm raincloud plots



org.plot<-ggplot(Organic.data, aes(x = host, y = percent_resistant, fill = host))+ 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
 
  scale_fill_manual(values = wes_palette( "Darjeeling1", n=5))+
  coord_cartesian(xlim = c(1.2, NA), clip = "off")+
 
  theme_pubr()

##Changing x axis label order
org.plot <- org.plot + scale_x_discrete(name ="host", 
                     limits=c("Cattle","Chicken","Pigs", "Turkey", "Environment"))

org.1 <-org.plot+labs(x = "Host", y = "Percent resistance", 
                     title = "Organic farms")+
  theme(legend.position = "none")
              


##Conventional plots

#subseting conventionalfarm data

conv.data <- data3 %>%
  filter(farm_type == "Conventional")



conv.plot<-ggplot(conv.data, aes(x = host, y = percent_resistant, fill = host))+
  
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
   scale_fill_manual(values = wes_palette( "Darjeeling1", n=5))+
  coord_cartesian(xlim = c(1.2, NA), clip = "off")+
  theme_pubr()

##Changing x axis label order
conv.plot <- conv.plot + scale_x_discrete(name ="host", 
                                        limits=c("Cattle","Chicken","Pigs", "Turkey", "Environment"))



conv.1<- conv.plot+labs(x = "Host", y = "Percent resistance",
                        title = "Conventional farms")+
  theme(legend.position = "none")



##Merge pathogen plots

host.plot <- (org.1 |conv.1)+ 
  plot_annotation(tag_levels = "a",
                  tag_prefix = "(",
                  tag_suffix = ")")+
  plot_layout(guides = "keep")&
  theme(plot.tag = element_text(),
        legend.position = "top")


host.plot


```
Figure 2





#### Foodborne pathogen resistance


Most of the surveys covered antimicrobials classified as critically important for human medicine by the World Health Organization (WHO, 2019). Our study covered 350,570 isolates from organic and conventional farms in Asia, Oceania, Europe, South America and North America testing resistance of Escherichia coli, Salmonella, Campylobacter, and Staphylococcus aureus.

The resistance in E. coli isolates in conventional farms was higher than in organic farms. There was higher resistance of amoxicillin-clavulanic acid (AMC) in Asia, 98%, (CI:95-100%) in both conventional and organic farms as compared to 32%, (CI:29-35%) and 20%, (CI:18-22%) in European conventional and organic farms respectively. In South America, the resistance of E. coli against AMC was 23%, (CI:16-30%) in organic farms while the resistance was lower in the North American organic farms at 3%. North America reported higher resistances in erythromycin 76%, (CI:73-79%) in conventional farms and 56%, (CI: 53-59%) in organic farms. Tylosin resistance was 64%, (CI:60-68%) and 36%, (CI: 32-40%) in conventional and organic farms respectively. Neomycin resistance was 63%, (CI:59-67%) in conventional and 24%, (CI:21-27%) in organic farms in North America while the resistance rate was 2%, (CI: 1-3%) in organic farms in Oceania.  

The resistance was higher in salmonella in Asia as compared to North America. Resistance of ampicillin in salmonella in Asia was 52%, (CI:47-57%) and 23%, (CI: 19-27%) in conventional and organic farms respectively while in North America the resistance was 22%, (CI: 21-23%) and 18%, (CI: 16-20%) in conventional and organic farms respectively. The salmonella resistance against streptomycin was 46%, (CI: 40-52%) and 21%, (CI: 17-25%) in conventional and organic farms respectively in Asia, while in North America, the streptomycin resistance against salmonella was 20%, (CI:19-21%) and 10%, (CI: 9-11%) in conventional and organic farms respectively. Gentamycin resistance was higher in conventional farms 31%, (CI: 27-35%) as compared to organic farms 4%, (CI: 2-6%) in Asia while in North America there was no significant difference between resistances in organic farms, 3%, (CI: 2-4%) and conventional farms 4%, (CI:3-5%). This was the same case in amoxicillin-clavulanic acid in North America where resistance in conventional farms was 23%, (CI: 21-25%) and 24%, (CI: 22-26%). However, there was a significant difference in amoxicillin-clavulanic acid resistance in Asia where organic farms had 6%, (CI: 3-9%) as compared to 19%, (CI: 15-23%).

In Europe, campylobacter had a higher resistance in norfloxacin, ofloxacin and ampicillin in organic farms with resistance rates of 91% (CI: 82-100%), 91% (CI: 82-100%) and 79% (CI: 67-91%) respectively. However, ampicillin recorded lower resistance rates than in conventional farms 66% (CI: 51-81%) as compared to organic farms. Ciprofloxacin resistance was lower in North America, 2% in organic farms as compared to 11% (CI: 10-12%) in organic and conventional farms respectively as compared to Europe 30% (CI: 27-33%) and 36% (32-40%) in organic and conventional farms respectively. Nalidixic acid resistance was higher in Europe as compared to North America in conventional and organic farms with resistance percentages of 31% (CI: 27-35%) and 35% (CI: 31-39%) in organic and conventional farms respectively as compared to 5% (CI: 4-6%) and 12% (CI: 11-13%) in organic and conventional farms respectively in North America.

Europe, North America, and Asia recorded the same resistance of erythromycin in enterococcus, 17% in organic farms. However, the resistance was higher in conventional farms as compared to organic farms. Oceania had a higher resistance of ciprofloxacin in conventional farms at 84% (CI: 80-88%) as compared to Asia, North America and Europe which recorded 31% (CI: 18-44%), 18% (13-23%) and 11% (CI: 7-15%) respectively. Europe however had higher resistance against Staphylococcus aureus in conventional farms 75% (CI: 67-83%) as compared to 38% (CI: 29-47%) in organic farms. Overall, the erythromycin resistance was lower in organic farms in Europe and North America with resistances of 10% (CI: 7-13%) and 6% (CI: 3-9%) respectively.


```{r continents,echo=FALSE, fig.height=15, fig.width=20, message=FALSE}

#Load data
main_data <- read_csv("conv.csv")




data1 <- main_data%>%
  mutate(
    continent =
      ifelse(continent == "Oceania", 
             "New Zealand", continent
      )
  )





data1 <- main_data %>%
  group_by(country) %>%
  select("continent",
         "doi",
         "farm_type",
         "host",
         "antimicrobial_compound",
         "antimicrobial_class",
         "pathogen",
         "percent_resistant",
         "no_isolates_resistant",
         "no_isolates_susceptible",
         "no_isolates_intermidiate",
         "no_isolates" )

#changing percentage resistance into numeric class and rounding off  
data1$percent_resistant <- as.numeric(as.character
                                          (data1$percent_resistant))

data1$percent_resistant <- round(data1$percent_resistant, digits = 0)

data2 <- data1 %>%
  select("doi",
    "continent",
         "farm_type",
         "host",
         "antimicrobial_compound",
         "antimicrobial_class",
         "pathogen",
         "percent_resistant",
    "no_isolates_resistant",
    "no_isolates_susceptible",
    "no_isolates_intermidiate",
         "no_isolates" )



data3 <- data2 %>%select("continent",
                        "doi",
                         "farm_type",
                        "host",
                         "antimicrobial_compound",
                        "pathogen",
                         "percent_resistant", "no_isolates")%>%
filter(pathogen != "Arcanobacterium pyogenes", pathogen != "Corynebacterium bovis",
           pathogen != "Environmental streptococci")
 

#changing percentage resistance into numeric class and rounding off  
data3$percent_resistant <- as.numeric(as.character
                                      (data3$percent_resistant))

data3$percent_resistant <- round(data3$percent_resistant, digits = 0)
#####################################################################################

ecoli<- subset(data3, pathogen == "E.coli")
#create a function to return the number of resistant isolates
new.function1 <- function(x,y) {
  (x*y)/100}

ResIsoEcoli <- mapply(new.function1, ecoli$percent_resistant, ecoli$no_isolates)
ResIsoEcoli <- round(ResIsoEcoli, digits = 0)
AMR.tmp.ecoli <- cbind(ecoli, ResIsoEcoli)

#determine total NIsolates
EcoliNIsolates <- aggregate(no_isolates ~ doi + continent + farm_type + 
                             antimicrobial_compound + pathogen + percent_resistant+
                             ResIsoEcoli, data = AMR.tmp.ecoli, FUN = sum)


EcoliNIsolates$no_isolates <- sapply(EcoliNIsolates$no_isolates, function(x) sum(unlist(x)))

#aggregate all resistant isolates and all NIsolates by speciesag, compound and region
ecolires <- aggregate(ResIsoEcoli ~ antimicrobial_compound  + farm_type+
                       continent, 
                     data = AMR.tmp.ecoli, FUN = sum)
ecoliAll <- aggregate(no_isolates ~ antimicrobial_compound  + farm_type+
                       continent, 
                     data = AMR.tmp.ecoli, FUN = sum)
#and divide ResIso/NIsolates to return true mean
EcoliMean <- round((ecolires$ResIsoEcoli /ecoliAll$no_isolates)*100, digits = 0)
EcoliMeanDF <- as.data.frame(cbind(ecolires$antimicrobial_compound,
                                  ecolires$farm_type, ecolires$continent,
                                  EcoliMean, ecoliAll$no_isolates))
colnames(EcoliMeanDF) <- c("antimicrobial_compound","farm_type","continent",
                           "Mean","no_isolates")
EcoliMeanDF$Mean <- as.numeric(as.character(EcoliMeanDF$Mean))
EcoliMeanDF$no_isolates <- as.numeric(as.character(EcoliMeanDF$no_isolates))
#restrict display drug pairings where NIsolates > 10
EcoliMeanDF = EcoliMeanDF[which(EcoliMeanDF$no_isolates >= 10),]

# Compute the 95% CI of proportion where x = p_hat and y = n two tailed z = 1.96
CI.function <- function(x,y) {
  x + c(-1.96,1.96)*sqrt(x*(1-x)/y)}

#95% CI
CIecoli<- as.data.frame(t(mapply(CI.function, EcoliMeanDF$Mean/100, EcoliMeanDF$no_isolates)))
EcoliMeanDF <-cbind(EcoliMeanDF, round(CIecoli*100, digits = 0))
colnames(EcoliMeanDF) <- c("antimicrobial_compound", "farm_type","continent",
                         "Mean","no_isolates","CILow","CIHigh")
EcoliMeanDF$CILow[EcoliMeanDF$CILow < 0] = 0
EcoliMeanDF$CIHigh[EcoliMeanDF$CIHigh >100] = 100

##remove data with less than 1% resistance
EcoliMeanDF <- EcoliMeanDF%>%
  filter(Mean>1)




  
##Ecoli bars  

##Europe
europe.ecoli <- EcoliMeanDF %>%
  filter(continent == "Europe")

europe.ecoli<- europe.ecoli[order(-europe.ecoli$Mean), ]

europe.ecoli.plot <- ggbarplot(europe.ecoli, "antimicrobial_compound", "Mean", 
                               fill = "farm_type", position = position_dodge(0.7),
                               subtitle = "Europe, E.coli n= 18,910",
                               xlab = FALSE, ylab = FALSE,
                               legend.title = "Farm type",
                                font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))





#Asia 
asia.ecoli <- EcoliMeanDF %>%
  filter(continent == "Asia")

##Ordering bar graphs in descending order
asia.ecoli<- asia.ecoli[order(-asia.ecoli$Mean), ]

asia.ecoli.plot <- ggbarplot(asia.ecoli, "antimicrobial_compound", "Mean", 
                             fill = "farm_type", position = position_dodge(0.7),
                             subtitle = "Asia, E.coli n= 970",
                             xlab = FALSE, ylab = FALSE,
                             legend.title = "Farm type",
                             font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))




##North America

N.A.ecoli <- EcoliMeanDF %>%
  filter(continent == "North America")

N.A.ecoli<- N.A.ecoli[order(-N.A.ecoli$Mean), ]

N.A.ecoli.plot <- ggbarplot(N.A.ecoli, "antimicrobial_compound", "Mean", 
                            fill = "farm_type", position = position_dodge(0.7),
                            subtitle = "North America, E.coli n= 27,381",
                            xlab = FALSE, ylab = FALSE,
                            legend.title = "Farm type",
                             font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))





#Oceania

oceania.ecoli <- EcoliMeanDF %>%
  filter(continent == "Oceania")

oceania.ecoli<- oceania.ecoli[order(-oceania.ecoli$Mean), ]

oceania.ecoli.plot <- ggbarplot(oceania.ecoli, "antimicrobial_compound", "Mean", 
                                fill = "farm_type", position = position_dodge(0.7),
                                subtitle = "Oceania, E.coli n= 4,756",
                                xlab = FALSE, ylab = FALSE,
                                legend.title = "Farm type", 
                               font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))



#South america

S.A.ecoli <- EcoliMeanDF %>%
  filter(continent == "South America")

S.A.ecoli<- S.A.ecoli[order(-S.A.ecoli$Mean), ]

S.A.ecoli.plot <- ggbarplot(S.A.ecoli, "antimicrobial_compound", "Mean", 
                            fill = "farm_type", position = position_dodge(0.7),
                            subtitle = "South America, E.coli n= 2340",
                            xlab = FALSE, ylab = FALSE,
                            legend.title = "Farm type", 
                             font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))







##Enterococcus data

entero<- subset(data3, pathogen == "Enterococcus")
#create a function to return the number of resistant isolates
new.function1 <- function(x,y) {
  (x*y)/100}

ResIsoEntero <- mapply(new.function1, entero$percent_resistant, entero$no_isolates)
ResIsoEntero <- round(ResIsoEntero, digits = 0)
AMR.tmp.entero <- cbind(entero, ResIsoEntero)

#determine total NIsolates
EnteroNIsolates <- aggregate(no_isolates ~ doi + continent + farm_type + 
                              antimicrobial_compound + pathogen + percent_resistant+
                              ResIsoEntero, data = AMR.tmp.entero, FUN = sum)


EnteroNIsolates$no_isolates <- sapply(EnteroNIsolates$no_isolates, function(x) sum(unlist(x)))

#aggregate all resistant isolates and all NIsolates by speciesag, compound and region
enterores <- aggregate(ResIsoEntero ~ antimicrobial_compound  + farm_type+
                        continent, 
                      data = AMR.tmp.entero, FUN = sum)
enteroAll <- aggregate(no_isolates ~ antimicrobial_compound  + farm_type+
                        continent, 
                      data = AMR.tmp.entero, FUN = sum)
#and divide ResIso/NIsolates to return true mean
EnteroMean <- round((enterores$ResIsoEntero /enteroAll$no_isolates)*100, digits = 0)
EnteroMeanDF <- as.data.frame(cbind(enterores$antimicrobial_compound,
                                   enterores$farm_type, enterores$continent,
                                   EnteroMean, enteroAll$no_isolates))
colnames(EnteroMeanDF) <- c("antimicrobial_compound","farm_type","continent",
                           "Mean","no_isolates")
EnteroMeanDF$Mean <- as.numeric(as.character(EnteroMeanDF$Mean))
EnteroMeanDF$no_isolates <- as.numeric(as.character(EnteroMeanDF$no_isolates))

#restrict display drug pairings where NIsolates > 10
EnteroMeanDF = EnteroMeanDF[which(EnteroMeanDF$no_isolates >= 10),]

# Compute the 95% CI of proportion where x = p_hat and y = n two tailed z = 1.96
CI.function <- function(x,y) {
  x + c(-1.96,1.96)*sqrt(x*(1-x)/y)}

#95% CI
CIentero<- as.data.frame(t(mapply(CI.function, EnteroMeanDF$Mean/100,
                                  EnteroMeanDF$no_isolates)))
EnteroMeanDF <-cbind(EnteroMeanDF, round(CIentero*100, digits = 0))

colnames(EnteroMeanDF) <- c("antimicrobial_compound", "farm_type","continent",
                           "Mean","no_isolates","CILow","CIHigh")

EnteroMeanDF$CILow[EnteroMeanDF$CILow < 0] = 0
EnteroMeanDF$CIHigh[EnteroMeanDF$CIHigh >100] = 100

##remove data with less than 1% resistance
EnteroMeanDF <- EnteroMeanDF%>%
  filter(Mean>1)

###Bar plots

##Asia enterococcus bar plot

asia.entero <- EnteroMeanDF %>%
  filter(continent == "Asia")

asia.entero<- asia.entero[order(-asia.entero$Mean), ]

asia.entero.plot <- ggbarplot(asia.entero, "antimicrobial_compound", "Mean", 
                              fill = "farm_type", 
                              position = position_dodge(0.7),
                              subtitle = "Asia, Enterococcus n= 468",
                              xlab = FALSE, ylab = FALSE,
                              legend.title = "Farm type",
                             font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))





##Europe Enterococcus bar plot

europe.entero <- EnteroMeanDF %>%
  filter(continent == "Europe")

europe.entero<- europe.entero[order(-europe.entero$Mean), ]

europe.enterococcus.plot <- ggbarplot(europe.entero, "antimicrobial_compound",
                                      "Mean", 
                                      fill = "farm_type", position = position_dodge(0.7),
                                      subtitle = "Europe, Enterococcus n= 4,196",
                                      xlab = FALSE, ylab = FALSE,
                                      legend.title = "Farm type",
                                       font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))






##North America, Enterococcus bar plot

N.A.entero <- EnteroMeanDF %>%
  filter(continent == "North America")

N.A.entero<- N.A.entero[order(-N.A.entero$Mean), ]


N.A.entero.plot <- ggbarplot(N.A.entero, "antimicrobial_compound", "Mean", 
                             fill = "farm_type", position = position_dodge(0.7),
                             subtitle = "North America, Enterococcus n= 4,746",
                             xlab = FALSE, ylab = FALSE,
                             legend.title = "Farm type", 
                            font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))






##Oceania, Enterococcus bar plot

oceania.entero <- EnteroMeanDF %>%
  filter(continent == "Oceania",)

oceania.entero<- oceania.entero[order(-oceania.entero$Mean), ]

oceania.enterococcus.plot <- ggbarplot(oceania.entero, "antimicrobial_compound",
                                       "Mean", 
                                       fill = "farm_type", position = position_dodge(0.7),
                                       subtitle = "Oceania, Enterococcus n= 1765",
                                       xlab = FALSE, ylab = FALSE,
                                       legend.title = "Farm type",
                                       font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))







##Listeria data

listeria<- subset(data3, pathogen == "Listeria")
#create a function to return the number of resistant isolates
new.function1 <- function(x,y) {
  (x*y)/100}

ResIsoListeria <- mapply(new.function1,listeria$percent_resistant,
                         listeria$no_isolates)

ResIsoListeria <- round(ResIsoListeria, digits = 0)
AMR.tmp.listeria <- cbind(listeria, ResIsoListeria)

#determine total NIsolates
ListeriaNIsolates <- aggregate(no_isolates ~ doi + continent + farm_type + 
                              antimicrobial_compound + pathogen + percent_resistant+
                              ResIsoListeria, data = AMR.tmp.listeria, FUN = sum)


ListeriaNIsolates$no_isolates <- sapply(ListeriaNIsolates$no_isolates, function(x) sum(unlist(x)))

#aggregate all resistant isolates and all NIsolates by  compound and region
listeriares <- aggregate(ResIsoListeria ~ antimicrobial_compound  + farm_type+
                        continent, 
                      data = AMR.tmp.listeria, FUN = sum)

listeriaAll <- aggregate(no_isolates ~ antimicrobial_compound  + farm_type+
                        continent, 
                      data = AMR.tmp.listeria, FUN = sum)
#and divide ResIso/NIsolates to return true mean
ListeriaMean <- round((listeriares$ResIsoListeria /listeriaAll$no_isolates)*100, digits = 0)
ListeriaMeanDF <- as.data.frame(cbind(listeriares$antimicrobial_compound,
                                   listeriares$farm_type, listeriares$continent,
                                   ListeriaMean, listeriaAll$no_isolates))

colnames(ListeriaMeanDF) <- c("antimicrobial_compound","farm_type","continent",
                           "Mean","no_isolates")

ListeriaMeanDF$Mean <- as.numeric(as.character(ListeriaMeanDF$Mean))
ListeriaMeanDF$no_isolates <- as.numeric(as.character(ListeriaMeanDF$no_isolates))

#restrict display drug pairings where NIsolates > 10
ListeriaMeanDF = ListeriaMeanDF[which(ListeriaMeanDF$no_isolates >= 10),]

# Compute the 95% CI of proportion where x = p_hat and y = n two tailed z = 1.96
CI.function <- function(x,y) {
  x + c(-1.96,1.96)*sqrt(x*(1-x)/y)}

#95% CI
CIlisteria<- as.data.frame(t(mapply(CI.function, ListeriaMeanDF$Mean/100,
                                    ListeriaMeanDF$no_isolates)))
ListeriaMeanDF <-cbind(ListeriaMeanDF, round(CIlisteria*100, digits = 0))
colnames(ListeriaMeanDF) <- c("antimicrobial_compound", "farm_type","continent",
                           "Mean","no_isolates","CILow","CIHigh")
ListeriaMeanDF$CILow[ListeriaMeanDF$CILow < 0] = 0
ListeriaMeanDF$CIHigh[ListeriaMeanDF$CIHigh >100] = 100

##remove data with less than 1% resistance
ListeriaMeanDF <- ListeriaMeanDF%>%
  filter(Mean>1)


#Listeria plots


##Asia listeria bar plot

asia.list <- ListeriaMeanDF %>%
  filter(continent == "Asia")

asia.list<- asia.list[order(-asia.list$Mean), ]

asia.listeria.plot <- ggbarplot(asia.list, "antimicrobial_compound",
                                "Mean", 
                                fill = "farm_type", position = position_dodge(0.7),
                                subtitle = "Asia, Listeria n= 480",
                                xlab = FALSE, ylab = FALSE,
                                legend.title = "Farm type",
                                font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))






##Europe Listeria bar plot

europe.list <- ListeriaMeanDF %>%
  filter(continent == "Europe")

europe.list<- europe.list[order(-europe.list$Mean), ]

europe.listeria.plot <- ggbarplot(europe.list, "antimicrobial_compound", 
                                  "Mean", 
                                  fill = "farm_type", position = position_dodge(0.7),
                                  subtitle = "Europe, Listeria n= 32",
                                  xlab = FALSE, ylab = FALSE,
                                  legend.title = "Farm type", 
                                   font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))




##Salmonella


sal<- subset(data3, pathogen == "Salmonella")
#create a function to return the number of resistant isolates
new.function1 <- function(x,y) {
  (x*y)/100}

ResIsoSal <- mapply(new.function1, sal$percent_resistant, sal$no_isolates)
ResIsoSal  <- round(ResIsoSal , digits = 0)
AMR.tmp.sal <- cbind(sal, ResIsoSal)

#determine total NIsolates
SalNIsolates <- aggregate(no_isolates ~ doi + continent + farm_type + 
                              antimicrobial_compound + pathogen + percent_resistant+
                            ResIsoSal, data = AMR.tmp.sal, FUN = sum)


SalNIsolates$no_isolates <- sapply(SalNIsolates$no_isolates, function(x) sum(unlist(x)))

#aggregate all resistant isolates and all NIsolates by speciesag, compound and region
salres <- aggregate(ResIsoSal ~ antimicrobial_compound  + farm_type+
                        continent, 
                      data = AMR.tmp.sal, FUN = sum)
salAll <- aggregate(no_isolates ~ antimicrobial_compound  + farm_type+
                        continent, 
                      data = AMR.tmp.sal, FUN = sum)
#and divide ResIso/NIsolates to return true mean
SalMean <- round((salres$ResIsoSal /salAll$no_isolates)*100, digits = 0)

SalMeanDF <- as.data.frame(cbind(salres$antimicrobial_compound,
                                   salres$farm_type, salres$continent,
                                   SalMean, salAll$no_isolates))
colnames(SalMeanDF) <- c("antimicrobial_compound","farm_type","continent",
                           "Mean","no_isolates")


SalMeanDF$Mean <- as.numeric(as.character(SalMeanDF$Mean))
SalMeanDF$no_isolates <- as.numeric(as.character(SalMeanDF$no_isolates))
#restrict display drug pairings where NIsolates > 10
SalMeanDF = SalMeanDF[which(SalMeanDF$no_isolates >= 10),]

# Compute the 95% CI of proportion where x = p_hat and y = n two tailed z = 1.96
CI.function <- function(x,y) {
  x + c(-1.96,1.96)*sqrt(x*(1-x)/y)}

#95% CI
CIsal<- as.data.frame(t(mapply(CI.function, SalMeanDF$Mean/100, 
                               SalMeanDF$no_isolates)))
SalMeanDF <-cbind(SalMeanDF, round(CIsal*100, digits = 0))

colnames(SalMeanDF) <- c("antimicrobial_compound", "farm_type","continent",
                           "Mean","no_isolates","CILow","CIHigh")

SalMeanDF$CILow[SalMeanDF$CILow < 0] = 0
SalMeanDF$CIHigh[SalMeanDF$CIHigh >100] = 100

##remove data with less than 1% resistance
SalMeanDF <- SalMeanDF%>%
  filter(Mean>1)



##Asia Salmonella bar plot

asia.sal <- SalMeanDF %>%
  filter(continent == "Asia")

asia.sal<- asia.sal[order(-asia.sal$Mean), ]

asia.salmonella.plot <- ggbarplot(asia.sal, "antimicrobial_compound",
                                  "Mean", 
                                  fill = "farm_type", position = position_dodge(0.7),
                                  subtitle = "Asia, Salmonella n= 5,924",
                                  xlab = FALSE, ylab = FALSE,
                                  legend.title = "Farm type",
                                 font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))






##North America, Salmonella bar plot

N.A.sal <- SalMeanDF %>%
  filter(continent == "North America")

N.A.sal <- N.A.sal [order(-N.A.sal$Mean), ]

N.A.salmonella.plot <- ggbarplot(N.A.sal, "antimicrobial_compound", 
                                 "Mean", 
                                 fill = "farm_type", position = position_dodge(0.7),
                                 subtitle = "North America, Salmonella n= 22,696",
                                 xlab = FALSE, ylab = FALSE,
                                 legend.title = "Farm type", 
                                 font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))






##Staphylocccus data


staph<- subset(data3, pathogen == "Staphylococcus")
#create a function to return the number of resistant isolates
new.function1 <- function(x,y) {
  (x*y)/100}

ResIsoStaphi <- mapply(new.function1, staph$percent_resistant, staph$no_isolates)
ResIsoStaphi <- round(ResIsoStaphi, digits = 0)
AMR.tmp.staph <- cbind(staph, ResIsoStaphi)

#determine total NIsolates
StaphNIsolates <- aggregate(no_isolates ~ doi + continent + farm_type + 
                              antimicrobial_compound + pathogen + percent_resistant+
                              ResIsoStaphi, data = AMR.tmp.staph, FUN = unique)


StaphNIsolates$no_isolates <- sapply(StaphNIsolates$no_isolates, function(x) sum(unlist(x)))

#aggregate all resistant isolates and all NIsolates by host compound and region
staphres <- aggregate(ResIsoStaphi ~ antimicrobial_compound  + farm_type+
                        continent, 
                      data = AMR.tmp.staph, FUN = sum)
staphAll <- aggregate(no_isolates ~ antimicrobial_compound  + farm_type+
                        continent, 
                      data = AMR.tmp.staph, FUN = sum)
#and divide ResIso/NIsolates to return true mean
StaphMean <- round((staphres$ResIsoStaphi /staphAll$no_isolates)*100, digits = 0)

StaphMeanDF <- as.data.frame(cbind(staphres$antimicrobial_compound,
                                  staphres$farm_type, staphres$continent,
                                   StaphMean, staphAll$no_isolates))

colnames(StaphMeanDF) <- c("antimicrobial_compound","farm_type","continent",
                           "Mean","no_isolates")
StaphMeanDF$Mean <- as.numeric(as.character(StaphMeanDF$Mean))
StaphMeanDF$no_isolates <- as.numeric(as.character(StaphMeanDF$no_isolates))


#restrict display drug pairings where NIsolates > 10
StaphMeanDF <- StaphMeanDF[which(StaphMeanDF$no_isolates >= 10),]

# Compute the 95% CI of proportion where x = p_hat and y = n two tailed z = 1.96
CI.function <- function(x,y) {
  x + c(-1.96,1.96)*sqrt(x*(1-x)/y)}

#95% CI
CIstaph<- as.data.frame(t(mapply(CI.function, StaphMeanDF$Mean/100, StaphMeanDF$no_isolates)))
StaphMeanDF <-cbind(StaphMeanDF, round(CIstaph*100, digits = 0))
colnames(StaphMeanDF) <- c("antimicrobial_compound", "farm_type","continent",
                           "Mean","no_isolates","CILow","CIHigh")
StaphMeanDF$CILow[StaphMeanDF$CILow < 0] = 0
StaphMeanDF$CIHigh[StaphMeanDF$CIHigh >100] = 100

##remove data with less than 1% resistance
StaphMeanDF <- StaphMeanDF%>%
  filter(Mean>1)


##Bar plots

##Asia Staphylococcus bar plot

asia.staph <- StaphMeanDF %>%
  filter(continent == "Asia")

asia.staph<- asia.staph[order(-asia.staph$Mean), ]


asia.Staphylococcus.plot <- ggbarplot(asia.staph, "antimicrobial_compound", "Mean", 
                                      fill = "farm_type", position = position_dodge(0.7),
                                      subtitle = "Asia, Staphylococcus n= 972",
                                      xlab = FALSE, ylab = FALSE,
                                      legend.title = "Farm type",
                                     font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))








##North America, Staphylococcus bar plot

N.A.staphy <- StaphMeanDF %>%
  filter(continent == "North America")

N.A.staphy<- N.A.staphy[order(-N.A.staphy$Mean), ]

N.A.Staphylococcus.plot <- ggbarplot(N.A.staphy, "antimicrobial_compound", "Mean", 
                                     fill = "farm_type", position = position_dodge(0.7),
                                     subtitle = "North America, Staphylococcus n= 405",
                                     xlab = FALSE, ylab = FALSE,
                                     legend.title = "Farm type", 
                                    font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))





##Campylobacter


campy<- subset(data3, pathogen == "Campylobacter")
#create a function to return the number of resistant isolates
new.function1 <- function(x,y) {
  (x*y)/100}

ResIsoCampy <- mapply(new.function1, campy$percent_resistant, campy$no_isolates)
ResIsoCampy  <- round(ResIsoCampy , digits = 0)
AMR.tmp.campy <- cbind(campy, ResIsoCampy)

#determine total NIsolates
CampyNIsolates <- aggregate(no_isolates ~ doi + continent + farm_type + 
                            antimicrobial_compound + pathogen + percent_resistant+
                            ResIsoCampy, data = AMR.tmp.campy, FUN = sum)


CampyNIsolates$no_isolates <- sapply(CampyNIsolates$no_isolates, function(x) sum(unlist(x)))

#aggregate all resistant isolates and all NIsolates by speciesag, compound and region
campyres <- aggregate(ResIsoCampy ~ antimicrobial_compound  + farm_type+
                      continent, 
                    data = AMR.tmp.campy, FUN = sum)
campyAll <- aggregate(no_isolates ~ antimicrobial_compound  + farm_type+
                      continent, 
                    data = AMR.tmp.campy, FUN = sum)
#and divide ResIso/NIsolates to return true mean
CampyMean <- round((campyres$ResIsoCampy /campyAll$no_isolates)*100, digits = 0)

CampyMeanDF <- as.data.frame(cbind(campyres$antimicrobial_compound,
                                campyres$farm_type, campyres$continent,
                                 CampyMean, campyAll$no_isolates))
colnames(CampyMeanDF) <- c("antimicrobial_compound","farm_type","continent",
                         "Mean","no_isolates")


CampyMeanDF$Mean <- as.numeric(as.character(CampyMeanDF$Mean))
CampyMeanDF$no_isolates <- as.numeric(as.character(CampyMeanDF$no_isolates))
#restrict display drug pairings where NIsolates > 10
CampyMeanDF = CampyMeanDF[which(CampyMeanDF$no_isolates >= 10),]

# Compute the 95% CI of proportion where x = p_hat and y = n two tailed z = 1.96
CI.function <- function(x,y) {
  x + c(-1.96,1.96)*sqrt(x*(1-x)/y)}

#95% CI
CIcampy<- as.data.frame(t(mapply(CI.function, CampyMeanDF$Mean/100, 
                               CampyMeanDF$no_isolates)))
CampyMeanDF <-cbind(CampyMeanDF, round(CIcampy*100, digits = 0))

colnames(CampyMeanDF) <- c("antimicrobial_compound", "farm_type","continent",
                         "Mean","no_isolates","CILow","CIHigh")

CampyMeanDF$CILow[CampyMeanDF$CILow < 0] = 0
CampyMeanDF$CIHigh[CampyMeanDF$CIHigh >100] = 100

##remove data with less than 1% resistance
CampyMeanDF <- CampyMeanDF%>%
  filter(Mean>1)



##Europe Campylobacter bar plot

europe.campy <- CampyMeanDF %>%
  filter(continent == "Europe")

europe.campy<- europe.campy[order(-europe.campy$Mean), ]

europe.Campylobacter.plot <- ggbarplot(europe.campy, "antimicrobial_compound", "Mean", 
                                       fill = "farm_type", position = position_dodge(0.7),
                                       subtitle = "Europe, Campylobacter n= 4966",
                                       xlab = FALSE, ylab = FALSE,
                                       legend.title = "Farm type",
                                      font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))






##North America, campylobacter bar plot

N.A.campylobacter <- CampyMeanDF %>%
  filter(continent == "North America")

N.A.campylobacter<- N.A.campylobacter[order(-N.A.campylobacter$Mean), ]

N.A.campylobacter.plot <- ggbarplot(N.A.campylobacter, "antimicrobial_compound", "Mean", 
                                    fill = "farm_type", position = position_dodge(0.7),
                                    subtitle = "North America, Campylobacter n= 22,586",
                                    xlab = FALSE, ylab = FALSE,
                                    legend.title = "Farm type", 
                                    font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))





##Methicillin-resistant staphylococcus aureus - MRSA

mrsa<- subset(data3, pathogen == "MRSA")
#create a function to return the number of resistant isolates
new.function1 <- function(x,y) {
  (x*y)/100}

ResIsoMrsa <- mapply(new.function1, mrsa$percent_resistant, mrsa$no_isolates)
ResIsoMrsa <- round(ResIsoMrsa, digits = 0)
AMR.tmp.mrsa <- cbind(mrsa, ResIsoMrsa)

#determine total NIsolates
MrsaNIsolates <- aggregate(no_isolates ~ doi + continent + farm_type + 
                              antimicrobial_compound + pathogen + percent_resistant+
                              ResIsoMrsa, data = AMR.tmp.mrsa, FUN = sum)


MrsaNIsolates$no_isolates <- sapply(MrsaNIsolates$no_isolates, function(x) sum(unlist(x)))

#aggregate all resistant isolates and all NIsolates by speciesag, compound and region
mrsares <- aggregate(ResIsoMrsa ~ antimicrobial_compound  + farm_type+
                        continent, 
                      data = AMR.tmp.mrsa, FUN = sum)
mrsaAll <- aggregate(no_isolates ~ antimicrobial_compound  + farm_type+
                        continent, 
                      data = AMR.tmp.mrsa, FUN = sum)
#and divide ResIso/NIsolates to return true mean
MrsaMean <- round((mrsares$ResIsoMrsa /mrsaAll$no_isolates)*100, digits = 0)

MrsaMeanDF <- as.data.frame(cbind(mrsares$antimicrobial_compound,
                                   mrsares$farm_type,mrsares$continent,
                                   MrsaMean, mrsaAll$no_isolates))

colnames(MrsaMeanDF) <- c("antimicrobial_compound","farm_type","continent",
                           "Mean","no_isolates")


MrsaMeanDF$Mean <- as.numeric(as.character(MrsaMeanDF$Mean))

MrsaMeanDF$no_isolates <- as.numeric(as.character(MrsaMeanDF$no_isolates))

#restrict display drug pairings where NIsolates > 10
MrsaMeanDF = MrsaMeanDF[which(MrsaMeanDF$no_isolates >= 10),]

# Compute the 95% CI of proportion where x = p_hat and y = n two tailed z = 1.96
CI.function <- function(x,y) {
  x + c(-1.96,1.96)*sqrt(x*(1-x)/y)}

#95% CI

CImrsa<- as.data.frame(t(mapply(CI.function, MrsaMeanDF$Mean/100,
                                    MrsaMeanDF$no_isolates)))

MrsaMeanDF <-cbind(MrsaMeanDF, round(CImrsa*100, digits = 0))
colnames(MrsaMeanDF) <- c("antimicrobial_compound", "farm_type","continent",
                           "Mean","no_isolates","CILow","CIHigh")

MrsaMeanDF$CILow[MrsaMeanDF$CILow < 0] = 0
MrsaMeanDF$CIHigh[MrsaMeanDF$CIHigh >100] = 100

##remove data with less than 1% resistance
MrsaMeanDF <- MrsaMeanDF%>%
  filter(Mean>1)



##Europe MRSA bar plot

europe.MRSA <- MrsaMeanDF %>%
  filter(continent == "Europe")

europe.MRSA<- europe.MRSA[order(-europe.MRSA$Mean), ]

europe.MRSA.plot <- ggbarplot(europe.MRSA, "antimicrobial_compound", 
                              "Mean", 
                              fill = "farm_type", position = position_dodge(0.7),
                              subtitle = "Europe, MRSA n= 2,933",
                              xlab = FALSE, ylab = FALSE,
                              legend.title = "Farm type", 
                              font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))






##S.aureus
saureus<- subset(data3, pathogen == "S.aureus")
#create a function to return the number of resistant isolates
new.function1 <- function(x,y) {
  (x*y)/100}

ResIsoSaureus <- mapply(new.function1, saureus$percent_resistant, saureus$no_isolates)
ResIsoSaureus  <- round(ResIsoSaureus , digits = 0)
AMR.tmp.saureus <- cbind(saureus, ResIsoSaureus)

#determine total NIsolates
SaureusNIsolates <- aggregate(no_isolates ~ doi + continent + farm_type + 
                            antimicrobial_compound + pathogen + percent_resistant+
                            ResIsoSaureus, data = AMR.tmp.saureus, FUN = sum)


SaureusNIsolates$no_isolates <- sapply(SaureusNIsolates$no_isolates, function(x) sum(unlist(x)))

#aggregate all resistant isolates and all NIsolates by speciesag, compound and region
saureusres <- aggregate(ResIsoSaureus ~ antimicrobial_compound  + farm_type+
                      continent, 
                    data = AMR.tmp.saureus, FUN = sum)
saureusAll <- aggregate(no_isolates ~ antimicrobial_compound  + farm_type+
                      continent, 
                    data = AMR.tmp.saureus, FUN = sum)

#and divide ResIso/NIsolates to return true mean
SaureusMean <- round((saureusres$ResIsoSaureus /saureusAll$no_isolates)*100, 
                     digits = 0)

SaureusMeanDF <- as.data.frame(cbind(saureusres$antimicrobial_compound,
                                 saureusres$farm_type, saureusres$continent,
                                 SaureusMean, saureusAll$no_isolates))

colnames(SaureusMeanDF) <- c("antimicrobial_compound","farm_type","continent",
                         "Mean","no_isolates")


SaureusMeanDF$Mean <- as.numeric(as.character(SaureusMeanDF$Mean))
SaureusMeanDF$no_isolates <- as.numeric(as.character(SaureusMeanDF$no_isolates))
#restrict display drug pairings where NIsolates > 10
SaureusMeanDF <- SaureusMeanDF[which(SaureusMeanDF$no_isolates >= 10),]

# Compute the 95% CI of proportion where x = p_hat and y = n two tailed z = 1.96
CI.function <- function(x,y) {
  x + c(-1.96,1.96)*sqrt(x*(1-x)/y)}

#95% CI
CIsaureus<- as.data.frame(t(mapply(CI.function, SaureusMeanDF$Mean/100, 
                               SaureusMeanDF$no_isolates)))
SaureusMeanDF <-cbind(SaureusMeanDF, round(CIsaureus*100, digits = 0))

colnames(SaureusMeanDF) <- c("antimicrobial_compound", "farm_type","continent",
                         "Mean","no_isolates","CILow","CIHigh")

SaureusMeanDF$CILow[SaureusMeanDF$CILow < 0] = 0
SaureusMeanDF$CIHigh[SaureusMeanDF$CIHigh >100] = 100

##remove data with less than 1% resistance
SaureusMeanDF <- SaureusMeanDF%>%
  filter(Mean>1)



##Europe S.aureus bar plot

europe.saureus <- SaureusMeanDF %>%
  filter(continent == "Europe")

europe.saureus<- europe.saureus[order(-europe.saureus$Mean), ]

europe.s.aureus.plot <- ggbarplot(europe.saureus, "antimicrobial_compound", 
                                  "Mean", 
                                  fill = "farm_type", position = position_dodge(0.7),
                                  subtitle = "Europe, S.aureus n= 3,950",
                                  xlab = FALSE, ylab = FALSE,
                                  legend.title = "Farm type",
                                 font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))





##North America, S.aureus bar plot

N.A.saureus <- SaureusMeanDF %>%
  filter(continent == "North America")

N.A.saureus<- N.A.saureus[order(-N.A.saureus$Mean), ]

N.A.saureus.plot <- ggbarplot(N.A.saureus, "antimicrobial_compound",
                              "Mean", 
                             fill = "farm_type", position = position_dodge(0.7),
                             subtitle = "North America, S.aureus n= 1,521",
                             xlab = FALSE, ylab = FALSE,
                             legend.title = "Farm type", 
                             font.subtitle = "italic")+
  rotate_x_text(90)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))





##Putting all plots together using patchwork

continent_plot1 <- (asia.ecoli.plot | europe.ecoli.plot | N.A.ecoli.plot | S.A.ecoli.plot) / 
                    (oceania.ecoli.plot | asia.salmonella.plot | N.A.salmonella.plot |europe.Campylobacter.plot)/
                    (N.A.campylobacter.plot | asia.entero.plot | europe.enterococcus.plot | N.A.entero.plot )/
                    (oceania.enterococcus.plot | europe.s.aureus.plot |N.A.saureus.plot)+
  plot_annotation(tag_levels = "a",
                  tag_prefix = "(",
                  tag_suffix = ")")+
  plot_layout(guides = "collect")&
  theme(plot.tag = element_text(face = "italic"),
        legend.position = "top")


continent_plot1


```

#### Antimicrobial class resistance at the country level



China had a higher resistance to macrolide, a critically important antimicrobial to human medicine in organic and conventional farms at 97% (CI: 94-100%) and 100% respectively as compared to the United States of America which recorded 21% CI (20-11%) and 33% CI: (32-34%) in organic and conventional farms respectively. Tetracycline antibiotic class had lower resistance rates in both organic and conventional farms by 15% (CI: 14-16%) in Sweden as compared to the United States of America with 55% (CI: 54-56%) and 38% (CI: 37-39%) in conventional and organic farms respectively. China had the highest sulfonamide resistance in conventional farms, 31% (25-37%) and the lowest sulfonamide resistance in organic farms, 2% CI: (0-4%) as compared to other countries while both USA and Sweden reported the lowest resistance rate in organic farms at 11%.


```{r country,echo=FALSE, fig.height=15, fig.width=17, message=FALSE}


#Load data
main_data <- read_csv("conv.csv")


data1 <- main_data %>%
  group_by(country) %>%
  select("country",
         "doi",
         "farm_type",
         "host",
         "antimicrobial_compound",
         "antimicrobial_class",
         "pathogen",
         "percent_resistant",
         "no_isolates_resistant",
         "no_isolates_susceptible",
         "no_isolates_intermidiate",
         "no_isolates" )

#changing percentage resistance into numeric class and rounding off  
data1$percent_resistant <- as.numeric(as.character
                                      (data1$percent_resistant))

data1$percent_resistant <- round(data1$percent_resistant, digits = 0)

data2 <- data1 %>%
  select("doi",
         "country",
         "farm_type",
         "host",
         "antimicrobial_compound",
         "antimicrobial_class",
         "pathogen",
         "percent_resistant",
         "no_isolates_resistant",
         "no_isolates_susceptible",
         "no_isolates_intermidiate",
         "no_isolates" )






data3 <- data2 %>%select("country",
                         "doi",
                         "farm_type",
                         "host",
                         "antimicrobial_class",
                         "pathogen",
                         "percent_resistant", "no_isolates")%>%
  filter(pathogen != "Arcanobacterium pyogenes", pathogen != "Corynebacterium bovis",
         pathogen != "Environmental streptococci")


#changing percentage resistance into numeric class and rounding off  
data3$percent_resistant <- as.numeric(as.character
                                      (data3$percent_resistant))

data3$percent_resistant <- round(data3$percent_resistant, digits = 0)




usa<- data3
#create a function to return the number of resistant isolates
new.function1 <- function(x,y) {
  (x*y)/100}

ResIsousa <- mapply(new.function1, usa$percent_resistant, usa$no_isolates)
ResIsousa <- round(ResIsousa, digits = 0)
AMR.tmp.usa <- cbind(usa, ResIsousa)

#determine total NIsolates
usaNIsolates <- aggregate(no_isolates ~ doi + country + farm_type + 
                              antimicrobial_class + pathogen + percent_resistant+
                              ResIsousa, data = AMR.tmp.usa, FUN = sum)


usaNIsolates$no_isolates <- sapply(usaNIsolates$no_isolates, function(x) sum(unlist(x)))

#aggregate all resistant isolates and all NIsolates by speciesag, compound and region
usares <- aggregate(ResIsousa ~ antimicrobial_class  + farm_type+
                        country, 
                      data = AMR.tmp.usa, FUN = sum)
usaAll <- aggregate(no_isolates ~ antimicrobial_class  + farm_type+
                        country, 
                      data = AMR.tmp.usa, FUN = sum)
#and divide ResIso/NIsolates to return true mean
usaMean <- round((usares$ResIsousa /usaAll$no_isolates)*100, digits = 0)
usaMeanDF <- as.data.frame(cbind(usares$antimicrobial_class,
                                   usares$farm_type, usares$country,
                                  usaMean, usaAll$no_isolates))
colnames(usaMeanDF) <- c("antimicrobial_class","farm_type","country",
                           "Mean","no_isolates")
usaMeanDF$Mean <- as.numeric(as.character(usaMeanDF$Mean))
usaMeanDF$no_isolates <- as.numeric(as.character(usaMeanDF$no_isolates))
#restrict display drug pairings where NIsolates > 10
usaMeanDF = usaMeanDF[which(usaMeanDF$no_isolates >= 10),]

# Compute the 95% CI of proportion where x = p_hat and y = n two tailed z = 1.96
CI.function <- function(x,y) {
  x + c(-1.96,1.96)*sqrt(x*(1-x)/y)}

#95% CI
CIusa<- as.data.frame(t(mapply(CI.function, usaMeanDF$Mean/100, usaMeanDF$no_isolates)))
usaMeanDF <-cbind(usaMeanDF, round(CIusa*100, digits = 0))
colnames(usaMeanDF) <- c("antimicrobial_class", "farm_type","country",
                           "Mean","no_isolates","CILow","CIHigh")
usaMeanDF$CILow[usaMeanDF$CILow < 0] = 0
usaMeanDF$CIHigh[usaMeanDF$CIHigh >100] = 100

##remove data with less than 1% resistance
usaMeanDF <- usaMeanDF%>%
  filter(Mean>1)

country.data <- usaMeanDF


##usa bar plot
usa.1 <- usaMeanDF %>%
  filter(country == "United States of America")

usa.1<- usa.1[order(-usa.1$Mean), ]

usa.bar <- ggbarplot(usa.1, "antimicrobial_class", "Mean", 
                               fill = "farm_type", position = position_dodge(0.7),
                               subtitle = "USA, n= 22,122",
                               xlab = FALSE, ylab = FALSE,
                               legend.title = "Farm type",
                               font.subtitle = "italic")+
  rotate_x_text(45)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))




##Denmark plot

den.1 <- usaMeanDF %>%
  filter(country == "Denmark")

den.1<- den.1[order(-den.1$Mean), ]

den.bar <- ggbarplot(den.1, "antimicrobial_class", "Mean", 
                     fill = "farm_type", position = position_dodge(0.7),
                     subtitle = "Denmark, n= 468 ",
                     xlab = FALSE, ylab = FALSE,
                     legend.title = "Farm type",
                     font.subtitle = "italic")+
  rotate_x_text(45)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))





##Sweden bar plot

swe.1 <- usaMeanDF %>%
  filter(country == "Sweden")

swe.1<- swe.1[order(-swe.1$Mean), ]

sweden.bar <- ggbarplot(swe.1, "antimicrobial_class", "Mean", 
                     fill = "farm_type", position = position_dodge(0.7),
                     subtitle = "Sweden, n= 28,259",
                     xlab = FALSE, ylab = FALSE,
                     legend.title = "Farm type",
                     font.subtitle = "italic")+
  rotate_x_text(45)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))





##South kores bar plot

s.k1 <- usaMeanDF %>%
  filter(country == "South Korea")

s.k1<- s.k1[order(-s.k1$Mean), ]

Southkorea.bar <- ggbarplot(s.k1, "antimicrobial_class", "Mean", 
                        fill = "farm_type", position = position_dodge(0.7),
                        subtitle = "South Korea, n= 2,382",
                        xlab = FALSE, ylab = FALSE,
                        legend.title = "Farm type",
                        font.subtitle = "italic")+
  rotate_x_text(60)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))




##China bar plot

china.1 <- usaMeanDF %>%
  filter(country == "China")

china.1<- china.1[order(-china.1$Mean), ]

china.bar <- ggbarplot(china.1, "antimicrobial_class", "Mean", 
                            fill = "farm_type", position = position_dodge(0.7),
                            subtitle = "China, n= 3,544",
                            xlab = FALSE, ylab = FALSE,
                            legend.title = "Farm type",
                            font.subtitle = "italic")+
  rotate_x_text(60)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))






##Germany bar plot

ger.1 <- usaMeanDF %>%
  filter(country == "Germany")

ger.1<- ger.1[order(-ger.1$Mean), ]

germany.bar <- ggbarplot(ger.1, "antimicrobial_class", "Mean", 
                       fill = "farm_type", position = position_dodge(0.7),
                       subtitle = "Germany, n= 17,808",
                       xlab = FALSE, ylab = FALSE,
                       legend.title = "Farm type",
                       font.subtitle = "italic")+
  rotate_x_text(45)+
  geom_linerange(aes(group = farm_type, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))








##Putting all plots together using patchwork

country.plot <- (usa.bar | germany.bar | Southkorea.bar) / 
  (sweden.bar | den.bar | china.bar)+
  plot_annotation(tag_levels = "a",
                  tag_prefix = "(",
                  tag_suffix = ")")+
  plot_layout(guides = "collect")&
  theme(plot.tag = element_text(face = "italic"),
        legend.position = "top")


country.plot

```


#### Geography of resistance


**To be added when maps are ready**